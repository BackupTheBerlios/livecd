#!/initrd/bin/ash
#
# This script is part of mklivecd and is here to:
#   1) Check if we should eject the CD
#   2) If so unmount the cloop and CD, ensuring we have everything necessary
#      below
#   3) Eject the CD with a prompt (so eject must be in memory)
#   4) Run /sbin/halt as it would normally be run, but halt needs to be in
#      memory. We call it because the halt script would call /sbin/halt
#      where /sbin was a link to the cloop image (no longer accessible) so we
#      either need to have our own halt or pivot_root
#
# Copyright (C) 2003, Buchan Milne <bgmilne@cae.co.za>
#
#    This program is free software; you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation; either version 2 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program; if not, write to the Free Software
#    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#
# The latest version of this script can be found at http://livecd.berlios.de
#
# $Id: halt.local.in,v 1.10 2003/12/07 13:22:39 jaco Exp $
#

# Variables
MNTCDROM="/cdrom"
MNTLIVECD="/loopfs"
CMD="$1"
[ -z "$CMD" ] && CMD=/sbin/halt

# should we eject the CD?
EJECT=1
grep -q noeject /proc/cmdline && EJECT=

# We probably want to be able to localise this:
MSG="Remove the CD, and press [Enter] to power the computer off"

# Copy the binaries we need
cp -f /sbin/halt /sbin/reboot /initrd/sbin

# Find which device we want to eject:
#DEVICE=`cat /proc/mounts | grep /initrd$MNTCDROM | awk '{ print \$1 }'`

# move our /proc and /dev mounts and pivot (setting correct paths)
echo "Performing initrd pivot"
mount -n --move /dev /initrd/dev
mount -n --move /proc /initrd/proc
mkdir -p /initrd/ramfs
/initrd/sbin/pivot_root /initrd /initrd/ramfs

echo "Unmounting $MNTLIVECD"
umount $MNTLIVECD 2>/dev/null

# Unload the cloop module before trying to umount/eject CD
echo "Removing cloop module"
losetup -d /dev/cloop/0 2>/dev/null
rmmod cloop 2>/dev/null

# Turn on autoeject of CD-Rom
# (Stolen from the knoppix-reboot script)
for dev in /proc/sys/dev/cdrom*/lock; do
	[ -f "$dev" ] && echo 0 > "$dev";
done
if [ -n "$EJECT" ]; then
	for dev in /proc/sys/dev/cdrom*/autoeject; do
		[ -f "$dev" ] && echo 1 > "$dev";
	done
fi

echo "Unmounting $MNTCDROM"
umount $MNTCDROM 2>/dev/null

# We can unmount proc now
echo "Unmounting /proc"
umount /proc 2>/dev/null

# Hope this works ;-)
$CMD -i -d -p >/dev/null 2>/dev/null
